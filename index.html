<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ì¬ê³ ê´€ë¦¬">
    <meta name="theme-color" content="#007bff">

    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22ì¬ê³ ê´€ë¦¬ì‹œìŠ¤í…œ%22,%22short_name%22:%22ì¬ê³ ê´€ë¦¬%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#f4f6f9%22,%22theme_color%22:%22#007bff%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/2897/2897871.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2897/2897871.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --main-color: #007bff; --admin-color: #dc3545; --success-color: #28a745; --app-update: #6f42c1; }
        body { font-family: -apple-system, "Malgun Gothic", sans-serif; margin: 0; background: #f4f6f9; color: #333; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }

        .header { background: var(--main-color); color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding-top: env(safe-area-inset-top); }
        .admin-mode .header { background: var(--admin-color); }
        .back-btn { font-size: 20px; cursor: pointer; padding: 5px 10px; }

        .container { padding: 15px; max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .status-bar { font-size: 13px; padding: 12px; text-align: center; border-radius: 8px; margin-bottom: 12px; font-weight: bold; }

        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; aspect-ratio: 1/1; border: 2px solid #ccc; }
        #scan-feedback { text-align: center; padding: 12px; margin-top: 8px; border-radius: 8px; font-weight: bold; background: #e9ecef; font-size: 14px; }

        .btn { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size: 15px; transition: 0.2s; }
        .btn-blue { background: var(--main-color); color: white; }
        .btn-red { background: var(--admin-color); color: white; }
        .btn-green { background: var(--success-color); color: white; }
        .btn-purple { background: var(--app-update); color: white; }
        .btn-gray { background: #6c757d; color: white; }

        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        textarea { height: 150px; font-family: monospace; font-size: 12px; }

        .admin-ui { display: none; border: 2px dashed var(--admin-color); padding: 15px; border-radius: 12px; margin-top: 10px; background: #fff5f5; }
        .admin-mode .admin-ui { display: block; }

        .item-card { border-left: 6px solid var(--main-color); padding: 15px; background: #fff; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .admin-mode .item-card { border-left-color: var(--admin-color); }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px 0; padding-bottom: 30px; }
        .page-btn { padding: 10px 15px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .page-btn:disabled { background: #eee; color: #999; }
    </style>
</head>
<body>

<div class="header">
    <div class="back-btn" onclick="customBack()"><i class="fas fa-arrow-left"></i></div>
    <h2 style="margin:0; font-size: 18px;">ğŸ“¦ ì¬ê³  í†µí•© ê´€ë¦¬</h2>
    <div id="auth-status" onclick="toggleAdmin()" style="font-size: 11px; cursor: pointer; text-decoration: underline;">ğŸ” ì§ì› ëª¨ë“œ</div>
</div>

<div class="container">
    <div id="status-msg" class="status-bar" style="background: #eee;">â³ ì„œë²„ ë°ì´í„° ë¡œë”© ì¤‘...</div>

    <div class="admin-ui">
        <h4 style="margin:0 0 10px 0; color:var(--admin-color);">ğŸ› ï¸ ê´€ë¦¬ì í†µí•© ì„¤ì •</h4>
        <input type="password" id="gh-token" placeholder="GitHub í† í°(ghp_...)">
        
        <div style="background:#fff; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #ddd;">
            <button class="btn btn-gray" style="margin:0;" onclick="downloadTemplate()">ê¸°ë³¸ ì–‘ì‹ ë°›ê¸°</button>
            <button class="btn btn-blue" onclick="document.getElementById('upload-excel').click()">ìƒˆ ì—‘ì…€ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <input type="file" id="upload-excel" accept=".xlsx" style="display:none" onchange="handleFileUpload(event)">
            <button class="btn btn-red" onclick="generateAllQRs()">QR ì½”ë“œ ì¼ê´„ ìƒì„±(ZIP)</button>
            <div id="qr-status" style="font-size:10px; margin-top:5px; color:#666;"></div>
        </div>

        <div style="background:#fefefe; padding:10px; border-radius:8px; border:1px solid var(--app-update);">
            <textarea id="index-code" placeholder="ì—¬ê¸°ì— ìƒˆë¡œìš´ index.html ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
            <button class="btn btn-purple" id="app-update-btn" onclick="pushIndexToGithub()">ğŸš€ ì•± ì†ŒìŠ¤ì½”ë“œ ì„œë²„ ì—…ë°ì´íŠ¸</button>
        </div>
    </div>

    <div class="card">
        <div id="reader"></div>
        <div id="scan-feedback">ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...</div>
        <button id="camera-retry-btn" class="btn btn-gray" onclick="startScanner()" style="display:none; padding:8px; font-size:12px;">ğŸ“· ì¹´ë©”ë¼ ì¬ì‹œë„</button>
    </div>

    <div class="card" style="position: sticky; top: 75px; z-index: 900;">
        <input type="text" id="search-input" placeholder="ìœ„ì¹˜ID ë˜ëŠ” ê·œê²© ê²€ìƒ‰..." onkeyup="filterTable()">
    </div>

    <div id="data-list"></div>
    <div id="pagination-control" class="pagination"></div>

    <div class="admin-ui" style="position: sticky; bottom: 20px; z-index: 1000;">
        <button class="btn btn-green" id="sync-btn" onclick="pushToGithub()">ğŸ’¾ ë³€ê²½ëœ ì¬ê³  ë°ì´í„° ì„œë²„ ì €ì¥</button>
    </div>
</div>

<div id="qrcode-hidden" style="display:none"></div>

<script>
let inventoryData = [];
let isAdmin = false;
let html5QrCode;
let currentPage = 1;
const itemsPerPage = 50;
const REPO = 'bschoi-4126/list';
const HEADERS = ['ìœ„ì¹˜ID', 'ì¸µ', 'êµ¬ì—­', 'ë™', 'ë‹¨', 'í’ˆëª©ì½”ë“œ', 'ê·œê²©', 'ë‹¨ê°€', 'í˜„ì¬ì¬ê³ ', 'ì¬ê³ ê¸ˆì•¡'];

window.onload = function() {
    loadFromServer();
    if(localStorage.getItem('gh_token')) document.getElementById('gh-token').value = localStorage.getItem('gh_token');
    
    history.pushState(null, null, location.href);
    window.onpopstate = function() {
        customBack();
        history.pushState(null, null, location.href);
    };
};

function updateStatus(msg, bg) {
    const el = document.getElementById('status-msg');
    el.innerText = msg; el.style.background = bg;
}

function loadFromServer() {
    const url = `https://bschoi-4126.github.io/list/ë¦¬ìŠ¤íŠ¸.xlsx?v=${new Date().getTime()}`;
    fetch(url).then(res => res.arrayBuffer()).then(data => {
        const workbook = XLSX.read(data, {type: 'array'});
        inventoryData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        updateStatus("âœ… ì„œë²„ ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ", "#d4edda");
        renderTable();
        setTimeout(startScanner, 500); // DOM ì•ˆì •ì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ ì‹¤í–‰
    }).catch(() => {
        if(inventoryData.length === 0) updateStatus("âš ï¸ ì„œë²„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", "#fff3cd");
        startScanner();
    });
}

function startScanner() {
    const feedback = document.getElementById('scan-feedback');
    const retryBtn = document.getElementById('camera-retry-btn');
    
    // 1. ë³´ì•ˆ í™˜ê²½ ì²´í¬
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        feedback.innerHTML = "<span style='color:red'>âŒ ì—ëŸ¬: HTTPS ì—°ê²°ì´ ì•„ë‹ˆê±°ë‚˜ ì¹´ë©”ë¼ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>";
        return;
    }

    // 2. ê¸°ì¡´ ìŠ¤ìºë„ˆ ì •ë¦¬ ë° ì¬ì‹œì‘ (ê¶Œí•œ ìš”ì²­ ìµœì†Œí™”)
    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            html5QrCode = null;
            initScanner();
        }).catch(() => {
            html5QrCode = null;
            initScanner();
        });
    } else {
        initScanner();
    }
}

function initScanner() {
    const feedback = document.getElementById('scan-feedback');
    const retryBtn = document.getElementById('camera-retry-btn');
    
    html5QrCode = new Html5QrCode("reader");
    
    // 1ë²ˆ: í›„ë©´ ì¹´ë©”ë¼ ê³ ì • (environment)
    html5QrCode.start(
        { facingMode: "environment" }, 
        { fps: 15, qrbox: 250 },
        (text) => {
            document.getElementById('search-input').value = text;
            filterTable();
            feedback.innerText = "âœ… ìŠ¤ìº” ì„±ê³µ: " + text;
            setTimeout(() => { feedback.innerText = "QRì„ ìŠ¤ìº”í•˜ë©´ ìë™ìœ¼ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤."; }, 2000);
        }
    ).catch(err => {
        console.error("Camera Start Error:", err);
        feedback.innerHTML = `<span style='color:red'>âŒ ì¹´ë©”ë¼ ì—ëŸ¬: ${err}</span>`;
        retryBtn.style.display = "block"; // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë²„íŠ¼ í‘œì‹œ
    });
}

function renderTable(filter = "") {
    const listDiv = document.getElementById('data-list');
    const filtered = inventoryData.filter(item => 
        String(item['ìœ„ì¹˜ID'] || '').toLowerCase().includes(filter.toLowerCase()) || 
        String(item['ê·œê²©'] || '').toLowerCase().includes(filter.toLowerCase())
    );

    const totalPages = Math.ceil(filtered.length / itemsPerPage);
    if (currentPage > totalPages) currentPage = 1;
    const start = (currentPage - 1) * itemsPerPage;
    const paginatedItems = filtered.slice(start, start + itemsPerPage);

    let html = "";
    paginatedItems.forEach((row) => {
        const stock = parseInt(row['í˜„ì¬ì¬ê³ ']) || 0;
        const price = parseInt(row['ë‹¨ê°€']) || 0;
        html += `
        <div class="item-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <small style="color:#888;">ID: ${row['ìœ„ì¹˜ID'] || '-'}</small>
                <b style="color:var(--main-color); font-size:20px;">${stock.toLocaleString()}ê°œ</b>
            </div>
            <div style="margin:8px 0; font-size:16px;"><strong>${row['ê·œê²©'] || '-'}</strong></div>
            <div style="font-size:12px; color:#666;">ì˜ˆìƒê¸ˆì•¡: ${(stock * price).toLocaleString()}ì›</div>
            ${isAdmin ? `
            <div style="margin-top:10px;">
                <input type="number" value="${stock}" style="border:1px solid #ffcccc" onchange="updateVal('${row['ìœ„ì¹˜ID']}', 'í˜„ì¬ì¬ê³ ', this.value)">
            </div>` : ''}
        </div>`;
    });
    listDiv.innerHTML = html || "<p style='text-align:center; padding:30px; color:#999;'>ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    renderPagination(totalPages, filter);
}

function renderPagination(totalPages, filter) {
    const paginationDiv = document.getElementById('pagination-control');
    if (totalPages <= 1) { paginationDiv.innerHTML = ""; return; }
    paginationDiv.innerHTML = `
        <button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(-1, '${filter}')">ì´ì „</button>
        <span style="font-size:14px;">${currentPage} / ${totalPages}</span>
        <button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(1, '${filter}')">ë‹¤ìŒ</button>
    `;
}

function changePage(offset, filter) {
    currentPage += offset;
    renderTable(filter);
    window.scrollTo(0, 400);
}

function filterTable() {
    currentPage = 1;
    renderTable(document.getElementById('search-input').value);
}

function customBack() {
    const searchInput = document.getElementById('search-input');
    if (searchInput.value !== "") {
        searchInput.value = "";
        filterTable();
    } else {
        if(confirm("ì•±ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) window.close();
    }
}

function updateVal(locId, field, val) {
    const item = inventoryData.find(d => String(d['ìœ„ì¹˜ID']) === String(locId));
    if(item) {
        item[field] = parseInt(val) || 0;
        item['ì¬ê³ ê¸ˆì•¡'] = (parseInt(item['í˜„ì¬ì¬ê³ ']) || 0) * (parseInt(item['ë‹¨ê°€']) || 0);
    }
}

async function pushIndexToGithub() {
    const token = document.getElementById('gh-token').value;
    const content = document.getElementById('index-code').value;
    if(!token || !content) return alert("í† í°ê³¼ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    const btn = document.getElementById('app-update-btn');
    btn.disabled = true; btn.innerText = "ì—…ë°ì´íŠ¸ ì¤‘...";
    try {
        const base64Content = btoa(unescape(encodeURIComponent(content)));
        const apiURL = `https://api.github.com/repos/${REPO}/contents/index.html`;
        const getRes = await fetch(apiURL, { headers: { "Authorization": `token ${token}` } });
        let sha = "";
        if(getRes.ok) { const getData = await getRes.json(); sha = getData.sha; }
        const putRes = await fetch(apiURL, {
            method: "PUT",
            headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
            body: JSON.stringify({ message: "ì•± ì—…ë°ì´íŠ¸", content: base64Content, sha: sha })
        });
        if(putRes.ok) alert("âœ… ì•± ì—…ë°ì´íŠ¸ ì„±ê³µ!");
    } catch (err) { alert("ì—ëŸ¬: " + err.message); }
    finally { btn.disabled = false; btn.innerText = "ğŸš€ ì•± ì†ŒìŠ¤ì½”ë“œ ì„œë²„ ì—…ë°ì´íŠ¸"; }
}

async function pushToGithub() {
    const token = document.getElementById('gh-token').value;
    if(!token) return alert("í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.");
    const btn = document.getElementById('sync-btn');
    btn.disabled = true; btn.innerText = "ì €ì¥ ì¤‘...";
    try {
        const ws = XLSX.utils.json_to_sheet(inventoryData, {header: HEADERS});
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
        const base64Content = btoa(String.fromCharCode(...new Uint8Array(wbout)));
        const apiURL = `https://api.github.com/repos/${REPO}/contents/ë¦¬ìŠ¤íŠ¸.xlsx`;
        const getRes = await fetch(apiURL, { headers: { "Authorization": `token ${token}` } });
        let sha = "";
        if(getRes.ok) { const getData = await getRes.json(); sha = getData.sha; }
        const putRes = await fetch(apiURL, {
            method: "PUT",
            headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
            body: JSON.stringify({ message: "ë°ì´í„° ì—…ë°ì´íŠ¸", content: base64Content, sha: sha })
        });
        if(putRes.ok) alert("âœ… ë°ì´í„° ì €ì¥ ì„±ê³µ!");
    } catch (err) { alert("ì—ëŸ¬: " + err.message); }
    finally { btn.disabled = false; btn.innerText = "ğŸ’¾ ë³€ê²½ëœ ì¬ê³  ë°ì´í„° ì„œë²„ ì €ì¥"; }
}

function toggleAdmin() {
    const pw = prompt("ê´€ë¦¬ì ì•”í˜¸:");
    if (pw === "4126") {
        isAdmin = !isAdmin;
        document.body.classList.toggle('admin-mode', isAdmin);
        document.getElementById('auth-status').innerText = isAdmin ? "ğŸ”“ ê´€ë¦¬ì ëª¨ë“œ" : "ğŸ” ì§ì› ëª¨ë“œ";
        renderTable();
    }
}

function handleFileUpload(event) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        inventoryData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        updateStatus("ğŸ“‚ ë¡œì»¬ íŒŒì¼ ë¡œë“œ ì™„ë£Œ", "#d1ecf1");
        renderTable();
    };
    reader.readAsArrayBuffer(event.target.files[0]);
}

function downloadTemplate() {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([HEADERS]);
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, "ë¦¬ìŠ¤íŠ¸.xlsx");
}

async function generateAllQRs() {
    const zip = new JSZip();
    const status = document.getElementById('qr-status');
    const qrDiv = document.getElementById('qrcode-hidden');
    for (let i = 0; i < inventoryData.length; i++) {
        let locId = String(inventoryData[i]['ìœ„ì¹˜ID']);
        if(!locId || locId.length < 2) continue;
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, { text: locId, width: 250, height: 250 });
        await new Promise(r => setTimeout(r, 60));
        const img = qrDiv.querySelector('img');
        if(img) zip.file(`QR_${locId}.png`, img.src.split(',')[1], {base64: true});
        status.innerText = `ìƒì„± ì¤‘... (${i+1}/${inventoryData.length})`;
    }
    zip.generateAsync({type:"blob"}).then(blob => {
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = "QR_Codes.zip"; a.click();
        status.innerText = "âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ";
    });
}
</script>
</body>
</html>
