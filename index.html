<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ì¬ê³ ê´€ë¦¬">
    <meta name="theme-color" content="#007bff">
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22ì¬ê³ ê´€ë¦¬ì‹œìŠ¤í…œ%22,%22short_name%22:%22ì¬ê³ ê´€ë¦¬%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#f4f6f9%22,%22theme_color%22:%22#007bff%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/2897/2897871.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2897/2897871.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --main-color: #007bff; --admin-color: #dc3545; --success-color: #28a745; --update-color: #6f42c1; }
        body { font-family: -apple-system, "Malgun Gothic", sans-serif; margin: 0; background: #f4f6f9; color: #333; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* ìƒë‹¨ í—¤ë” ì˜ì—­ */
        .header { background: var(--main-color); color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding-top: env(safe-area-inset-top); }
        .admin-mode .header { background: var(--admin-color); }
        .back-btn { font-size: 22px; cursor: pointer; padding: 5px 12px; }

        .container { padding: 15px; max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 15px; text-align: center; }
        .status-bar { font-size: 13px; padding: 12px; text-align: center; border-radius: 8px; margin-bottom: 12px; font-weight: bold; transition: 0.3s; }

        /* ì¹´ë©”ë¼ ì¡°ì‘ ì˜ì—­ */
        #camera-wrapper { width: 100%; position: relative; background: #000; border-radius: 12px; overflow: hidden; aspect-ratio: 1/1; border: 3px solid var(--main-color); }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .btn { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size: 16px; transition: 0.2s; }
        .btn-blue { background: var(--main-color); color: white; }
        .btn-red { background: var(--admin-color); color: white; }
        .btn-green { background: var(--success-color); color: white; }
        .btn-purple { background: var(--update-color); color: white; }
        
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        textarea { height: 100px; font-family: monospace; font-size: 12px; }

        /* ê´€ë¦¬ììš© íŒ¨ë„ ë””ìì¸ */
        .admin-ui { display: none; border: 2px dashed var(--admin-color); padding: 15px; border-radius: 12px; margin-top: 10px; background: #fff5f5; text-align: left; }
        .admin-mode .admin-ui { display: block; }

        /* ì•„ì´í…œ ì¹´ë“œ: ê·œê²©(Spec)ì„ ê°€ì¥ í¬ê³  êµµê²Œ ê°•ì¡° */
        .item-card { border-left: 8px solid var(--main-color); padding: 18px; background: #fff; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); text-align: left; position: relative; }
        .admin-mode .item-card { border-left-color: var(--admin-color); }
        
        .item-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .item-id { font-size: 13px; color: #007bff; font-weight: bold; background: #e7f1ff; padding: 2px 8px; border-radius: 4px; }
        .stock-display { font-size: 24px; font-weight: 900; color: var(--main-color); position: absolute; top: 15px; right: 15px; }
        
        /* ê·œê²©(ê°•ì¡°)ê³¼ í’ˆëª©ëª…(ì¼ë°˜) ë°°ì¹˜ ë³€ê²½ */
        .item-spec { font-size: 19px; font-weight: 800; color: #111; margin-bottom: 4px; line-height: 1.3; width: 75%; }
        .item-title { font-size: 15px; color: #555; margin-bottom: 12px; font-weight: 500; }

        .item-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; font-size: 14px; color: #444; border-top: 1px solid #eee; padding-top: 10px; }
        .info-label { font-weight: bold; color: #777; margin-right: 5px; }

        /* ì¬ê³ ìˆ˜ì • ì…ë ¥ ë°•ìŠ¤ ë° ì ìš© ë²„íŠ¼ */
        .edit-box { margin-top: 15px; display: flex; gap: 8px; align-items: center; background: #fdf2f2; padding: 10px; border-radius: 8px; border: 1px solid #ffe3e3; }
        .edit-input { width: 80px !important; padding: 8px !important; margin: 0 !important; font-size: 14px !important; text-align: center; border: 1px solid #ccc !important; border-radius: 6px !important; }
        .apply-btn { width: auto !important; margin: 0 !important; padding: 8px 15px !important; font-size: 14px !important; background: var(--success-color); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px 0; padding-bottom: 50px; }
        .page-btn { padding: 10px 18px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .page-btn:disabled { background: #eee; color: #999; }
    </style>
</head>
<body>

<div class="header">
    <div class="back-btn" onclick="customBack()"><i class="fas fa-arrow-left"></i></div>
    <h2 style="margin:0; font-size: 18px;">ì¬ê³  í†µí•© ê´€ë¦¬</h2>
    <div id="auth-status" onclick="toggleAdmin()" style="font-size: 11px; cursor: pointer; text-decoration: underline;">ğŸ” ì§ì› ëª¨ë“œ</div>
</div>

<div class="container">
    <div id="status-msg" class="status-bar" style="background: #eee;">â³ ë°ì´í„° ë™ê¸°í™” ì‹œë„ ì¤‘...</div>

    <div class="admin-ui">
        <h4 style="margin:0 0 10px 0; color:var(--admin-color);">ğŸ› ï¸ ê´€ë¦¬ì íŒ¨ë„</h4>
        <input type="password" id="gh-token" placeholder="GitHub í† í° ì…ë ¥">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn btn-blue" onclick="downloadTemplate()">ì–‘ì‹ ë°›ê¸°</button>
            <button class="btn btn-blue" onclick="document.getElementById('upload-excel').click()">ì—‘ì…€ ì—…ë¡œë“œ</button>
            <input type="file" id="upload-excel" accept=".xlsx" style="display:none" onchange="handleFileUpload(event)">
        </div>
        <button class="btn btn-red" onclick="generateAllQRs()">A4 ìš©ì§€ QR ì¼ê´„ ìƒì„± (PDF)</button>
        <div id="qr-status" style="font-size:12px; color:var(--admin-color); margin-top:5px; font-weight:bold;"></div>
        
        <div style="margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">
            <p style="font-size:12px; font-weight:bold; color:var(--update-color);">í”„ë¡œê·¸ë¨(index.html) ì†ŒìŠ¤ ì—…ë°ì´íŠ¸</p>
            <textarea id="index-code" placeholder="ìƒˆë¡œìš´ ì†ŒìŠ¤ ì½”ë“œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
            <button class="btn btn-purple" onclick="pushIndexToGithub()">ğŸš€ ì†ŒìŠ¤ì½”ë“œ ì„œë²„ ì—…ë°ì´íŠ¸</button>
        </div>
    </div>

    <div class="card">
        <div id="camera-wrapper"><video id="video-feed" autoplay playsinline></video></div>
        <div id="scan-feedback" style="padding:10px; font-weight:bold;">QR ìŠ¤ìº”ì„ ìœ„í•´ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</div>
        <button id="camera-btn" class="btn btn-blue" onclick="toggleCamera()">ğŸ“· ì¹´ë©”ë¼ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div class="card" style="position: sticky; top: 75px; z-index: 900;">
        <input type="text" id="search-input" placeholder="ID ë˜ëŠ” í’ˆëª©ëª…/ê·œê²© ê²€ìƒ‰..." onkeyup="filterTable()">
    </div>

    <div id="data-list"></div>
    <div id="pagination-control" class="pagination"></div>

    <div class="admin-ui" style="position: sticky; bottom: 20px; z-index: 1000;">
        <button class="btn btn-green" onclick="pushToGithub(false)">ğŸ’¾ ì „ì²´ ë°ì´í„° ì„œë²„ ì €ì¥</button>
    </div>
</div>

<div id="qrcode-hidden" style="position: absolute; left: -9999px; top: -9999px;"></div>

<script>
let inventoryData = [];
let isAdmin = false;
let videoStream = null;
let isScanning = false;
let isSavingLock = false; 
let currentPage = 1;
const itemsPerPage = 50; 
const REPO = 'bschoi-4126/list';
const HEADERS = ['ìœ„ì¹˜ID', 'ì¸µ', 'êµ¬ì—­', 'ë™', 'ë‹¨', 'í’ˆëª©ì½”ë“œ', 'í’ˆëª©ëª…', 'ê·œê²©', 'í‘œì¤€ë‹¨ê°€', 'í˜„ì¬ì¬ê³ ', 'ì¬ê³ ê¸ˆì•¡'];

window.onload = function() {
    loadFromServer();
    if(localStorage.getItem('gh_token')) document.getElementById('gh-token').value = localStorage.getItem('gh_token');
    history.pushState(null, null, location.href);
    window.onpopstate = () => { customBack(); history.pushState(null, null, location.href); };
};

// ë©”ëª¨ë¦¬ ì´ˆê³¼ ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ ì•ˆì „í•œ ì¸ì½”ë”© í•¨ìˆ˜
function uint8ArrayToBase64(uint8) {
    let binary = '';
    const len = uint8.byteLength;
    for (let i = 0; i < len; i++) { binary += String.fromCharCode(uint8[i]); }
    return window.btoa(binary);
}

function updateStatus(msg, bg) {
    const el = document.getElementById('status-msg');
    if(el) { el.innerText = msg; el.style.background = bg; }
}

function loadFromServer() {
    // ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ ìœ„í•´ ìºì‹œ ë¬´ë ¥í™” íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
    const url = `https://bschoi-4126.github.io/list/ë¦¬ìŠ¤íŠ¸.xlsx?v=${new Date().getTime()}`;
    
    fetch(url).then(res => res.arrayBuffer()).then(data => {
        const workbook = XLSX.read(data, {type: 'array'});
        const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        
        inventoryData = rawData.map(item => {
            // ì¸µ ì •ë³´ ì •ê·œí™” (1 -> 1F)
            let floor = String(item['ì¸µ'] || '');
            if (floor && !floor.toUpperCase().includes('F')) floor += 'F';
            item['ì¸µ'] = floor;

            if (!item['ìœ„ì¹˜ID']) {
                const parts = [floor, item['êµ¬ì—­'], item['ë™'], item['ë‹¨']].filter(p => p);
                item['ìœ„ì¹˜ID'] = parts.join('-');
            }

            // ë‹¨ê°€ ì¸ì‹ ë° ê¸ˆì•¡ ìë™ ê³„ì‚°
            const unitPrice = parseInt(item['í‘œì¤€ë‹¨ê°€']) || parseInt(item['ë‹¨ê°€']) || 0;
            item['í‘œì¤€ë‹¨ê°€'] = unitPrice;
            item['ì¬ê³ ê¸ˆì•¡'] = unitPrice * (parseInt(item['í˜„ì¬ì¬ê³ ']) || 0);
            return item;
        });

        updateStatus("âœ… ì„œë²„ ë°ì´í„° ìµœì‹  ë™ê¸°í™” ì™„ë£Œ", "#d4edda");
        renderTable();
    }).catch(() => {
        updateStatus("âš ï¸ ì„œë²„ ì—°ê²° ëŒ€ê¸° ì¤‘...", "#fff3cd");
    });
}

// ì¹´ë©”ë¼ ë° QR ìŠ¤ìº” ë¡œì§ (ë„¤ì´í‹°ë¸Œ ë°”ì½”ë“œ ê°ì§€ê¸° ì‚¬ìš©)
async function toggleCamera() {
    const video = document.getElementById('video-feed');
    const btn = document.getElementById('camera-btn');
    const fb = document.getElementById('scan-feedback');
    if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null; isScanning = false;
        btn.innerText = "ğŸ“· ì¹´ë©”ë¼ ì‹œì‘í•˜ê¸°"; fb.innerText = "ì¹´ë©”ë¼ê°€ êº¼ì¡ŒìŠµë‹ˆë‹¤.";
        return;
    }
    try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = videoStream;
        btn.innerText = "ğŸ“· ì¹´ë©”ë¼ ë„ê¸°"; fb.innerText = "ğŸ” QR ì½”ë“œë¥¼ ì°¾ëŠ” ì¤‘...";
        startNativeScanner();
    } catch (err) { alert("ì¹´ë©”ë¼ ê¶Œí•œ ì˜¤ë¥˜: " + err); }
}

async function startNativeScanner() {
    if (isScanning || !('BarcodeDetector' in window)) return;
    isScanning = true;
    const detector = new BarcodeDetector({ formats: ['qr_code'] });
    const scan = async () => {
        if (!videoStream) return;
        try {
            const results = await detector.detect(document.getElementById('video-feed'));
            if (results.length > 0) {
                const text = results[0].rawValue;
                document.getElementById('search-input').value = text;
                filterTable();
                document.getElementById('scan-feedback').innerText = "âœ… ì¸ì‹ ì™„ë£Œ: " + text;
                window.scrollTo({ top: document.getElementById('search-input').offsetTop - 100, behavior: 'smooth' });
                setTimeout(scan, 3000); 
            } else { requestAnimationFrame(scan); }
        } catch (e) { requestAnimationFrame(scan); }
    };
    scan();
}

function renderTable(filter = "") {
    const listDiv = document.getElementById('data-list');
    const filtered = inventoryData.filter(item => 
        String(item['ìœ„ì¹˜ID'] || '').toLowerCase().includes(filter.toLowerCase()) || 
        String(item['í’ˆëª©ëª…'] || '').toLowerCase().includes(filter.toLowerCase()) || 
        String(item['ê·œê²©'] || '').toLowerCase().includes(filter.toLowerCase())
    );

    const totalPages = Math.ceil(filtered.length / itemsPerPage);
    if (currentPage > totalPages) currentPage = 1;
    const start = (currentPage - 1) * itemsPerPage;
    const paginatedItems = filtered.slice(start, start + itemsPerPage);

    let html = "";
    paginatedItems.forEach((row) => {
        const stock = parseInt(row['í˜„ì¬ì¬ê³ ']) || 0;
        const price = parseInt(row['í‘œì¤€ë‹¨ê°€']) || 0;
        
        // ë””ìì¸ ë°¸ëŸ°ìŠ¤: ê·œê²©(Bold) ìœ„, í’ˆëª©ëª…(Normal) ì•„ë˜
        html += `
        <div class="item-card">
            <div class="stock-display">${stock.toLocaleString()}ê°œ</div>
            <div class="item-top"><span class="item-id">ID: ${row['ìœ„ì¹˜ID'] || '-'}</span></div>
            <div class="item-spec">${row['ê·œê²©'] || '-'}</div>
            <div class="item-title">${row['í’ˆëª©ëª…'] || 'í’ˆëª©ëª… ì—†ìŒ'}</div>
            
            <div class="item-info-grid">
                <div><span class="info-label">í’ˆëª©ì½”ë“œ:</span>${row['í’ˆëª©ì½”ë“œ'] || '-'}</div>
                <div><span class="info-label">ìœ„ì¹˜:</span>${row['ì¸µ'] || ''} ${row['êµ¬ì—­'] || ''}êµ¬ì—­</div>
                <div><span class="info-label">í‘œì¤€ë‹¨ê°€:</span>${price.toLocaleString()}ì›</div>
                <div style="color: #e67e22; font-weight:bold;"><span class="info-label">ì¬ê³ ê¸ˆì•¡:</span>${(stock * price).toLocaleString()}ì›</div>
            </div>

            ${isAdmin ? `
            <div class="edit-box">
                <span style="font-size:12px; font-weight:bold;">ìˆ˜ëŸ‰ìˆ˜ì •:</span>
                <input type="number" id="input-${row['ìœ„ì¹˜ID']}" value="${stock}" class="edit-input">
                <button class="apply-btn" onclick="applyItemUpdate('${row['ìœ„ì¹˜ID']}')">ì ìš©</button>
            </div>` : ''}
        </div>`;
    });
    listDiv.innerHTML = html || "<p style='text-align:center; padding:50px;'>ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    renderPagination(totalPages, filter);
}

function renderPagination(totalPages, filter) {
    const div = document.getElementById('pagination-control');
    if (totalPages <= 1) { div.innerHTML = ""; return; }
    div.innerHTML = `
        <button class="page-btn" onclick="changePage(-1, '${filter}')" ${currentPage === 1 ? 'disabled' : ''}>ì´ì „</button>
        <span style="font-weight:bold; align-self:center;">${currentPage} / ${totalPages}</span>
        <button class="page-btn" onclick="changePage(1, '${filter}')" ${currentPage === totalPages ? 'disabled' : ''}>ë‹¤ìŒ</button>
    `;
}

function changePage(offset, filter) {
    currentPage += offset;
    renderTable(filter);
    window.scrollTo({ top: document.getElementById('search-input').offsetTop - 100, behavior: 'smooth' });
}

function filterTable() {
    currentPage = 1;
    renderTable(document.getElementById('search-input').value);
}

function customBack() {
    const input = document.getElementById('search-input');
    if (input.value !== "") { input.value = ""; filterTable(); }
    else { if(confirm("ì•±ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) window.close(); }
}

// ê°œë³„ ìˆ˜ì • í›„ ì‹¤ì‹œê°„ ë™ê¸°í™” ì €ì¥
async function applyItemUpdate(locId) {
    if (isSavingLock) return;
    const inputEl = document.getElementById(`input-${locId}`);
    const newVal = parseInt(inputEl.value) || 0;
    const item = inventoryData.find(d => String(d['ìœ„ì¹˜ID']) === String(locId));
    if(item) {
        item['í˜„ì¬ì¬ê³ '] = newVal;
        item['ì¬ê³ ê¸ˆì•¡'] = item['í˜„ì¬ì¬ê³ '] * (parseInt(item['í‘œì¤€ë‹¨ê°€']) || 0);
        renderTable(document.getElementById('search-input').value);
        await pushToGithub(true); 
    }
}

async function pushToGithub(isAuto = false) {
    if (isSavingLock) return;
    isSavingLock = true;
    const token = document.getElementById('gh-token').value;
    if(!token) { isSavingLock = false; return isAuto ? null : alert("GitHub í† í°ì„ ì…ë ¥í•˜ì„¸ìš”."); }
    localStorage.setItem('gh_token', token);
    
    try {
        const ws = XLSX.utils.json_to_sheet(inventoryData, {header: HEADERS});
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
        // ìŠ¤íƒ ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ Base64 ë³€í™˜
        const base64Content = uint8ArrayToBase64(new Uint8Array(wbout));
        
        const apiURL = `https://api.github.com/repos/${REPO}/contents/ë¦¬ìŠ¤íŠ¸.xlsx`;
        const getRes = await fetch(apiURL, { headers: { "Authorization": `token ${token}` } });
        let sha = getRes.ok ? (await getRes.json()).sha : "";
        
        const putRes = await fetch(apiURL, {
            method: "PUT",
            headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
            body: JSON.stringify({ message: "Stock Sync Update", content: base64Content, sha: sha })
        });
        
        if(putRes.ok) {
            updateStatus("âœ… ì„œë²„ ì €ì¥ ì™„ë£Œ (ë°˜ì˜ ëŒ€ê¸° ì¤‘)", "#d4edda");
            if(!isAuto) alert("âœ… ì„œë²„ ì €ì¥ ì„±ê³µ!");
        }
    } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
    finally { isSavingLock = false; }
}

async function handleFileUpload(event) {
    const token = document.getElementById('gh-token').value;
    if(!token) return alert("í† í°ì„ ë¨¼ì € ì…ë ¥í•´ì•¼ ì„œë²„ ìë™ ì €ì¥ì´ ì‘ë™í•©ë‹ˆë‹¤.");
    const reader = new FileReader();
    reader.onload = async (e) => {
        const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
        const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        inventoryData = rawData.map(item => {
            let floor = String(item['ì¸µ'] || '');
            if (floor && !floor.toUpperCase().includes('F')) floor += 'F';
            item['ì¸µ'] = floor;
            if (!item['ìœ„ì¹˜ID']) item['ìœ„ì¹˜ID'] = [floor, item['êµ¬ì—­'], item['ë™'], item['ë‹¨']].filter(p => p).join('-');
            const unitPrice = parseInt(item['í‘œì¤€ë‹¨ê°€']) || parseInt(item['ë‹¨ê°€']) || 0;
            item['í‘œì¤€ë‹¨ê°€'] = unitPrice;
            item['ì¬ê³ ê¸ˆì•¡'] = unitPrice * (parseInt(item['í˜„ì¬ì¬ê³ ']) || 0);
            return item;
        });
        renderTable();
        updateStatus("ğŸ“‚ ë¡œì»¬ ë¶„ì„ ì™„ë£Œ (ìë™ ì„œë²„ ì €ì¥ ì‹œë„...)", "#fff3cd");
        setTimeout(() => pushToGithub(true), 500);
    };
    reader.readAsArrayBuffer(event.target.files[0]);
}

function toggleAdmin() {
    const pw = prompt("ê´€ë¦¬ì ì•”í˜¸:");
    if (pw === "4126") {
        isAdmin = !isAdmin;
        document.body.classList.toggle('admin-mode', isAdmin);
        document.getElementById('auth-status').innerText = isAdmin ? "ğŸ”“ ê´€ë¦¬ì ëª¨ë“œ" : "ğŸ” ì§ì› ëª¨ë“œ";
        renderTable();
    }
}

function downloadTemplate() {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([HEADERS]);
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, "ë¦¬ìŠ¤íŠ¸.xlsx");
}

async function pushIndexToGithub() {
    const token = document.getElementById('gh-token').value;
    const content = document.getElementById('index-code').value;
    if(!token || !content) return alert("í† í°ê³¼ ì†ŒìŠ¤ ì½”ë“œ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
    try {
        const apiURL = `https://api.github.com/repos/${REPO}/contents/index.html`;
        const getRes = await fetch(apiURL, { headers: { "Authorization": `token ${token}` } });
        let sha = getRes.ok ? (await getRes.json()).sha : "";
        await fetch(apiURL, {
            method: "PUT",
            headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
            body: JSON.stringify({ message: "Update app code", content: btoa(unescape(encodeURIComponent(content))), sha: sha })
        });
        alert("ì•± ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ ì„±ê³µ!");
    } catch (e) { alert("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: " + e.message); }
}

// í•µì‹¬: A4 63ë¶„í•  PDF ìƒì„± ë¡œì§ ì™„ë²½ ë³µêµ¬
async function generateAllQRs() {
    if (inventoryData.length === 0) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const qrDiv = document.getElementById('qrcode-hidden');
    const status = document.getElementById('qr-status');
    
    const cellW = 30; const cellH = 30; 
    const cols = 7; const rows = 9;   
    const itemsPerPagePDF = 63; 
    const startX = (210 - (cellW * cols)) / 2;
    const startY = (297 - (cellH * rows)) / 2;

    status.innerText = "â³ PDF ìƒì„± ì¤‘... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)";

    for (let i = 0; i < inventoryData.length; i++) {
        let id = String(inventoryData[i]['ìœ„ì¹˜ID']);
        if(!id) continue;

        // 63ê°œë§ˆë‹¤ ìƒˆ í˜ì´ì§€ ì¶”ê°€
        if (i > 0 && i % itemsPerPagePDF === 0) {
            doc.addPage();
        }

        const idxInPage = i % itemsPerPagePDF;
        const col = idxInPage % cols;
        const row = Math.floor(idxInPage / cols);
        
        const posX = startX + (col * cellW);
        const posY = startY + (row * cellH);

        // QR ìƒì„± (ì„ì‹œ ì˜ì—­)
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, { 
            text: id, 
            width: 120, 
            height: 120, 
            correctLevel: QRCode.CorrectLevel.H 
        });

        // ë Œë”ë§ì„ ìœ„í•œ ì•„ì£¼ ì§§ì€ ëŒ€ê¸° (ì¤‘ìš”)
        await new Promise(r => setTimeout(r, 60));
        
        const canvas = qrDiv.querySelector('canvas');
        if (canvas) {
            const imgData = canvas.toDataURL("image/png");
            doc.setFontSize(6);
            // í…ìŠ¤íŠ¸ ìœ„ì¹˜ë¥¼posY + 2ë¡œ ìµœëŒ€í•œ ì˜¬ë ¤ì„œ ê²¹ì¹¨ ë°©ì§€
            doc.text(id, posX + (cellW / 2), posY + 2, { align: "center", baseline: "top" });
            // QR ì´ë¯¸ì§€ ë°°ì¹˜ (25x25mm)
            doc.addImage(imgData, 'PNG', posX + 2.5, posY + 4.5, 25, 25);
            // ì»¤íŒ… ê°€ì´ë“œ ë¼ì¸
            doc.setDrawColor(220);
            doc.setLineDashPattern([1, 1], 0);
            doc.rect(posX, posY, cellW, cellH);
        }
        
        if (i % 10 === 0) status.innerText = `ì§„í–‰ ì¤‘... (${i+1}/${inventoryData.length})`;
    }

    doc.save("ì¬ê³ ê´€ë¦¬_QR_ì¸ì‡„ë¬¼_A4.pdf");
    status.innerText = "âœ… PDF ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!";
}
</script>
</body>
</html>
