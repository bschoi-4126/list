<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --main-color: #007bff; --admin-color: #dc3545; }
        body { font-family: -apple-system, "Malgun Gothic", sans-serif; margin: 0; background: #f4f6f9; color: #333; }
        .header { background: var(--main-color); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 1000; }
        .admin-mode .header { background: var(--admin-color); }
        .container { padding: 15px; max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size: 14px; }
        .btn-blue { background: var(--main-color); color: white; }
        .btn-gray { background: #6c757d; color: white; }
        .btn-red { background: var(--admin-color); color: white; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .admin-ui { display: none; border: 2px dashed var(--admin-color); padding: 10px; border-radius: 8px; margin-top: 10px; }
        .admin-mode .admin-ui { display: block; }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; background: #000; }
        .item-card { border-left: 5px solid var(--main-color); padding-left: 10px; margin-bottom: 10px; background: #fff; padding: 10px; border-radius: 5px; }
        .admin-mode .item-card { border-left-color: var(--admin-color); }
        .price-info { font-size: 13px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0">ğŸ“¦ ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
    <div id="auth-status" onclick="toggleAdmin()" style="font-size: 12px; margin-top: 5px; cursor: pointer;">ğŸ” ì§ì› ëª¨ë“œ (ì „í™˜í•˜ë ¤ë©´ í´ë¦­)</div>
</div>

<div class="container">
    <div class="admin-ui">
        <h4 style="margin:0; color:var(--admin-color);">ğŸ› ï¸ ê´€ë¦¬ì ì„¤ì •</h4>
        <button class="btn btn-gray" onclick="downloadTemplate()">ê¸°ë³¸ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-blue" onclick="document.getElementById('upload-excel').click()">ë¦¬ìŠ¤íŠ¸.xlsx ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <input type="file" id="upload-excel" accept=".xlsx" style="display:none" onchange="loadExcel(event)">
        <button class="btn btn-red" onclick="generateAllQRs()">ëª¨ë“  QR ìƒì„± (ZIP)</button>
        <div id="qr-status" style="font-size:12px; color:red; margin-top:5px;"></div>
    </div>

    <div class="card">
        <div id="reader"></div>
        <p id="scan-result" style="text-align:center; font-weight:bold; color:var(--main-color);"></p>
    </div>

    <div class="card" style="position: sticky; top: 70px; z-index: 900;">
        <input type="text" id="search-input" placeholder="ìœ„ì¹˜ID ë˜ëŠ” ê·œê²© ê²€ìƒ‰..." onkeyup="filterTable()">
    </div>

    <div id="data-list">
        <p style="text-align:center; color:#999;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”.</p>
    </div>

    <div class="admin-ui" style="position: sticky; bottom: 20px; z-index: 1000;">
        <button class="btn btn-red" onclick="exportToExcel()">ìˆ˜ì • ì™„ë£Œ í›„ ë¦¬ìŠ¤íŠ¸.xlsx ì €ì¥</button>
    </div>
</div>

<div id="qrcode-hidden" style="display:none"></div>

<script>
let inventoryData = [];
let isAdmin = false;
// ìš”ì²­í•˜ì‹  í•œê¸€ ì»¬ëŸ¼ êµ¬ì„±
const HEADERS = ['ìœ„ì¹˜ID', 'ì¸µ', 'êµ¬ì—­', 'ë™', 'ë‹¨', 'í’ˆëª©ì½”ë“œ', 'ê·œê²©', 'ë‹¨ê°€', 'í˜„ì¬ì¬ê³ ', 'ì¬ê³ ê¸ˆì•¡'];

function toggleAdmin() {
    if (!isAdmin) {
        const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (pw === "4126") {
            isAdmin = true;
            document.body.classList.add('admin-mode');
            document.getElementById('auth-status').innerText = "ğŸ”“ ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”";
            renderTable();
        } else { alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); }
    } else {
        isAdmin = false;
        document.body.classList.remove('admin-mode');
        document.getElementById('auth-status').innerText = "ğŸ” ì§ì› ëª¨ë“œ (ì „í™˜í•˜ë ¤ë©´ í´ë¦­)";
        renderTable();
    }
}

function loadExcel(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        inventoryData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        renderTable();
    };
    reader.readAsArrayBuffer(file);
}

function renderTable(filter = "") {
    const listDiv = document.getElementById('data-list');
    const filtered = inventoryData.filter(item => 
        String(item['ìœ„ì¹˜ID'] || '').toLowerCase().includes(filter.toLowerCase()) || 
        String(item['ê·œê²©'] || '').toLowerCase().includes(filter.toLowerCase())
    );

    let html = "";
    filtered.slice(0, 100).forEach(row => {
        const unitPrice = row['ë‹¨ê°€'] || 0;
        const currentStock = row['í˜„ì¬ì¬ê³ '] || 0;
        const totalAmount = unitPrice * currentStock; // ì¬ê³ ê¸ˆì•¡ ìë™ê³„ì‚°

        html += `
        <div class="item-card">
            <div style="display:flex; justify-content:space-between;">
                <small>${row['ìœ„ì¹˜ID'] || 'ìœ„ì¹˜ ë¯¸ì§€ì •'}</small>
                <b style="color:var(--main-color)">${currentStock}ê°œ</b>
            </div>
            <div style="margin:5px 0;"><strong>${row['ê·œê²©'] || '-'}</strong></div>
            <div class="price-info">
                ë‹¨ê°€: ${unitPrice.toLocaleString()}ì› | 
                ì¬ê³ ê¸ˆì•¡: <span style="color:var(--admin-color); font-weight:bold;">${totalAmount.toLocaleString()}ì›</span>
            </div>
            ${isAdmin ? `
            <div style="margin-top:10px;">
                <label style="font-size:11px;">ìˆ˜ëŸ‰ ë³€ê²½:</label>
                <input type="number" value="${currentStock}" onchange="updateValue('${row['ìœ„ì¹˜ID']}', 'í˜„ì¬ì¬ê³ ', this.value)">
                <label style="font-size:11px;">ë‹¨ê°€ ë³€ê²½:</label>
                <input type="number" value="${unitPrice}" onchange="updateValue('${row['ìœ„ì¹˜ID']}', 'ë‹¨ê°€', this.value)">
            </div>` : ''}
        </div>`;
    });
    listDiv.innerHTML = html || "<p style='text-align:center'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
}

function updateValue(locId, field, val) {
    const item = inventoryData.find(d => String(d['ìœ„ì¹˜ID']) === String(locId));
    if(item) {
        item[field] = parseInt(val) || 0;
        // ì¬ê³ ê¸ˆì•¡ ì»¬ëŸ¼ë„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        item['ì¬ê³ ê¸ˆì•¡'] = (item['í˜„ì¬ì¬ê³ '] || 0) * (item['ë‹¨ê°€'] || 0);
        renderTable(document.getElementById('search-input').value);
    }
}

function filterTable() {
    renderTable(document.getElementById('search-input').value);
}

function downloadTemplate() {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([HEADERS]);
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, "ë¦¬ìŠ¤íŠ¸.xlsx");
}

function exportToExcel() {
    // ì €ì¥ ì „ ëª¨ë“  í•­ëª©ì˜ ì¬ê³ ê¸ˆì•¡ ìµœì¢… ê³„ì‚°
    inventoryData.forEach(item => {
        item['ì¬ê³ ê¸ˆì•¡'] = (item['í˜„ì¬ì¬ê³ '] || 0) * (item['ë‹¨ê°€'] || 0);
    });
    const ws = XLSX.utils.json_to_sheet(inventoryData, {header: HEADERS});
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, "ë¦¬ìŠ¤íŠ¸.xlsx");
    alert("ìˆ˜ì •ëœ ë°ì´í„°ê°€ ë¦¬ìŠ¤íŠ¸.xlsxë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

async function generateAllQRs() {
    const zip = new JSZip();
    const status = document.getElementById('qr-status');
    const qrDiv = document.getElementById('qrcode-hidden');
    for (let i = 0; i < inventoryData.length; i++) {
        let locId = String(inventoryData[i]['ìœ„ì¹˜ID']);
        if(!locId || locId === 'undefined') continue;
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, { text: locId, width: 250, height: 250 });
        await new Promise(r => setTimeout(r, 50));
        const img = qrDiv.querySelector('img');
        if(img) zip.file(`QR_${locId}.png`, img.src.split(',')[1], {base64: true});
        status.innerText = `ìƒì„± ì¤‘ (${i+1}/${inventoryData.length})`;
    }
    zip.generateAsync({type:"blob"}).then(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "QR_Codes.zip";
        a.click();
        status.innerText = "ë‹¤ìš´ë¡œë“œ ì™„ë£Œ";
    });
}

const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
scanner.render((text) => {
    document.getElementById('scan-result').innerText = "ìŠ¤ìº”ë¨: " + text;
    document.getElementById('search-input').value = text;
    renderTable(text);
});
</script>
</body>
</html>